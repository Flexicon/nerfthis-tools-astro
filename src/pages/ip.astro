---
import IpGeolocation from '../components/IpGeolocation.astro';
import Layout from '../layouts/Layout.astro';
import IpService from '../server/ip';

const ipAddress = IpService.extractIpFromRequest(Astro.request);

const ipData = await IpService.getFromCacheOrAPI(ipAddress).catch((err) => {
  console.error('IP lookup failed:', err);
});
---

<Layout title="IP - NerfThis Tools">
  <div class="px-4 py-5 mt-5 text-center">
    <h1 class="display-5 fw-bold">🏠 IP Address</h1>
    <div class="col-lg-6 col-xl-5 mx-auto">
      <p class="lead mb-3">Here's your current IP Address and Geolocation data.</p>
    </div>
  </div>

  <div class="container">
    <div class="col-lg-8 col-xl-6 mx-auto">
      {
        ipData ? (
          <IpGeolocation data={ipData} />
        ) : (
          <>
            <p class="text-center">
              💩 oops. Catastrophically failed to lookup IP data.
              <br />
              The usual team of killer monkeys has been dispatched.
            </p>
          </>
        )
      }
    </div>
  </div>
</Layout>
