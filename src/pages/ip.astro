---
import IpGeolocation from '../components/IpGeolocation.astro';
import Layout from '../layouts/Layout.astro';

const xRealIp = Astro.request.headers.get('X-Real-Ip');
const xForwardedFor = Astro.request.headers.get('X-Forwarded-For') ?? '';

const ipAddr = xRealIp || xForwardedFor.split(',')[0];

let ipData = null;
let error = null;

try {
  ipData = await fetch(`http://ip-api.com/json/${ipAddr}`).then((res) => res.json());

  if (ipData.status !== 'success') throw new Error(ipData.message);
} catch (err) {
  error = err;
}
---

<Layout title="IP - NerfThis Tools">
  <div class="px-4 py-5 mt-5 text-center">
    <h1 class="display-5 fw-bold">🏠 IP Address</h1>
    <div class="col-lg-5 mx-auto">
      <p class="lead mb-3">Here's your current IP Address and Geolocation data.</p>
    </div>
  </div>

  <div class="container">
    <div class="col-lg-5 mx-auto">
      {
        ipData && !error ? (
          <IpGeolocation data={ipData} />
        ) : (
          <p>
            💩 oops. Catastrophically failed to lookup IP data. The usual team of killer monkeys has been dispatched.
          </p>
        )
      }
    </div>
  </div>
</Layout>
